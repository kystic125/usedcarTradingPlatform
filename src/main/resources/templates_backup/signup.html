<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì… - ìŠ¤ë§ˆíŠ¸í”½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #company-fields { display: none; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5" style="max-width: 500px;">
    <h2 class="text-center mb-4 fw-bold">íšŒì›ê°€ì…</h2>

    <div th:if="${errorMessage}" class="alert alert-danger text-center" role="alert">
        <span th:text="${errorMessage}">ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì—¬ê¸° ë‚˜ì˜µë‹ˆë‹¤</span>
    </div>

    <form action="/auth/signup" method="post" class="card p-4 shadow-sm border-0">

        <div class="mb-4 text-center">
            <label class="form-label fw-bold d-block">ê°€ì… ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</label>
            <div class="btn-group" role="group" aria-label="Basic radio toggle button group">

                <input type="radio" class="btn-check" name="role" id="roleCustomer" value="CUSTOMER" checked onclick="toggleRole('CUSTOMER')">
                <label class="btn btn-outline-primary" for="roleCustomer">ì¼ë°˜ íšŒì› (êµ¬ë§¤ì)</label>

                <input type="radio" class="btn-check" name="role" id="roleOwner" value="OWNER" onclick="toggleRole('OWNER')">
                <label class="btn btn-outline-dark" for="roleOwner">ê¸°ì—… íšŒì› (íŒë§¤ì)</label>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ë©”ì¼</label>
            <div class="input-group">
                <input type="email" id="email" name="email" class="form-control" placeholder="name@example.com" required>
                <button type="button" class="btn btn-outline-secondary" onclick="checkEmail()">ì¤‘ë³µ í™•ì¸</button>
            </div>
            <div id="emailFeedback" class="form-text"></div>
        </div>
        <div class="mb-3">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" name="password" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">ì´ë¦„ (ëŒ€í‘œìëª…)</label>
            <input type="text" name="name" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">ì „í™”ë²ˆí˜¸</label>
            <input type="text" name="phone" class="form-control" placeholder="010-1234-5678" required>
        </div>

        <div id="company-fields" class="p-3 mb-3 bg-secondary bg-opacity-10 rounded">
            <h6 class="fw-bold text-dark mb-3">ğŸ¢ ì‚¬ì—…ì ì •ë³´ ì…ë ¥</h6>
            <div class="mb-3">
                <label class="form-label">ìƒí˜¸ëª… (ê°€ê²Œ ì´ë¦„)</label>
                <input type="text" id="businessName" name="businessName" class="form-control" placeholder="ìŠ¤ë§ˆíŠ¸ ì¤‘ê³ ì°¨">
            </div>
            <div class="mb-3">
                <label class="form-label">ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</label>
                <input type="text" id="businessNumber" name="businessNumber" class="form-control" placeholder="000-00-00000">
                <button type="button" class="btn btn-outline-secondary" onclick="checkBusinessNumber()">ì¤‘ë³µ í™•ì¸</button>
            </div>
            <div id="businessFeedback" class="form-text"></div>
            <div class="mb-3">
                <label class="form-label">ì‚¬ì—…ì¥ ì£¼ì†Œ</label>
                <input type="text" id="address" name="address" class="form-control" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...">
            </div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-success w-100 py-2 fw-bold" disabled>ê°€ì…í•˜ê¸°</button>
    </form>

    <div class="d-flex align-items-center my-3">
        <hr class="flex-grow-1">
        <span class="mx-2 text-muted small">ë˜ëŠ”</span>
        <hr class="flex-grow-1">
    </div>

    <a href="/oauth2/authorization/kakao" class="btn btn-warning w-100 text-dark fw-bold mb-3">
        <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png" width="20" style="margin-right:5px"/>
        ì¹´ì¹´ì˜¤ë¡œ 3ì´ˆ ë§Œì— ì‹œì‘í•˜ê¸°
    </a>

    <div class="text-center mt-3">
        <a href="/login" class="text-decoration-none">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</a>
    </div>
</div>

<script>
    function toggleRole(role) {
        const companyFields = document.getElementById('company-fields');
        const businessNameInput = document.getElementById('businessName');
        const businessNumberInput = document.getElementById('businessNumber');
        const addressInput = document.getElementById('address');

        if (role === 'OWNER') {
            companyFields.style.display = 'block';
            businessNameInput.required = true;
            businessNumberInput.required = true;
            if(addressInput) addressInput.required = true;
        } else {
            companyFields.style.display = 'none';
            businessNameInput.required = false;
            businessNumberInput.required = false;
            if(addressInput) addressInput.required = false;
            businessNameInput.value = '';
            businessNumberInput.value = '';
            if(addressInput) addressInput.value = '';
        }
    }

    function checkEmail() {
        const emailInput = document.getElementById('email');
        const feedback = document.getElementById('emailFeedback');
        const submitBtn = document.getElementById('submitBtn');
        const email = emailInput.value;

        if (!email) {
            alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch('/api/check-email?email=' + email)
            .then(response => response.json())
            .then(isDuplicate => {
                if (isDuplicate) {
                    feedback.style.color = 'red';
                    feedback.textContent = "âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                    submitBtn.disabled = true; // ê°€ì… ë²„íŠ¼ ì ê¸ˆ
                    emailInput.classList.add('is-invalid');
                    emailInput.classList.remove('is-valid');
                } else {
                    feedback.style.color = 'green';
                    feedback.textContent = "âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                    submitBtn.disabled = false; // ê°€ì… ë²„íŠ¼ ì ê¸ˆ í•´ì œ
                    emailInput.classList.add('is-valid');
                    emailInput.classList.remove('is-invalid');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("ì¤‘ë³µ ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    document.getElementById('email').addEventListener('input', function() {
        const submitBtn = document.getElementById('submitBtn');
        const feedback = document.getElementById('emailFeedback');
        submitBtn.disabled = true;
        feedback.textContent = "";
        this.classList.remove('is-valid', 'is-invalid');
    });

    function checkBusinessNumber() {
        const businessInput = document.getElementById('businessNumber');
        const feedback = document.getElementById('businessFeedback');
        const submitBtn = document.getElementById('submitBtn');
        const number = businessInput.value;

        if (!number) {
            alert("ì‚¬ì—…ì ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch('/api/check-business?number=' + number)
            .then(response => response.json())
            .then(isDuplicate => {
                if (isDuplicate) {
                    feedback.style.color = 'red';
                    feedback.textContent = "âŒ ì´ë¯¸ ë“±ë¡ëœ ì‚¬ì—…ì ë²ˆí˜¸ì…ë‹ˆë‹¤.";
                    submitBtn.disabled = true; // ë²„íŠ¼ ì ê¸ˆ
                    businessInput.classList.add('is-invalid');
                    businessInput.classList.remove('is-valid');
                } else {
                    feedback.style.color = 'green';
                    feedback.textContent = "âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì‚¬ì—…ì ë²ˆí˜¸ì…ë‹ˆë‹¤.";
                    // ì£¼ì˜: ì´ë©”ì¼ë„ ê²€ì‚¬ê°€ í†µê³¼ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•˜ì§€ë§Œ, ì¼ë‹¨ì€ ë²„íŠ¼ì„ í’€ì–´ì¤ë‹ˆë‹¤.
                    // (ë” ì™„ë²½í•˜ê²Œ í•˜ë ¤ë©´ ì´ë©”ì¼ í†µê³¼ ì—¬ë¶€ ë³€ìˆ˜ë¥¼ ë”°ë¡œ ë‘¬ì•¼ í•¨)
                    submitBtn.disabled = false;
                    businessInput.classList.add('is-valid');
                    businessInput.classList.remove('is-invalid');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    document.getElementById('businessNumber').addEventListener('input', function() {
        const submitBtn = document.getElementById('submitBtn');
        const feedback = document.getElementById('businessFeedback');
        if(submitBtn) submitBtn.disabled = true;
        if(feedback) feedback.textContent = "";
        this.classList.remove('is-valid', 'is-invalid');
    });
</script>
</body>
</html>